<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>터치 기록 캔버스</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #canvasContainer {
            position: relative;
            border: 1px solid #ccc;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        #videoList {
            margin-top: 20px;
        }
        .videoItem {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="canvasContainer"></div>
    <div id="videoList"></div>
    <button id="resetBtn">초기화</button>

    <script>
        const canvasContainer = document.getElementById('canvasContainer');
        const videoList = document.getElementById('videoList');
        const resetBtn = document.getElementById('resetBtn');

        let isDrawing = false;
        let mediaRecorder;
        let chunks = [];
        let recordedVideos = [];
        let currentCanvas;
        let currentCtx;
        let baseCanvas;
        let baseCtx;

        // 캔버스 크기 설정
        function resizeCanvas() {
            const size = Math.min(window.innerWidth - 40, window.innerHeight - 100);
            canvasContainer.style.width = `${size}px`;
            canvasContainer.style.height = `${size}px`;
            
            if (baseCanvas) {
                baseCanvas.width = size;
                baseCanvas.height = size;
                baseCtx.fillStyle = 'black';
                baseCtx.fillRect(0, 0, size, size);
            }

            if (currentCanvas) {
                currentCanvas.width = size;
                currentCanvas.height = size;
            }
        }

        function createBaseCanvas() {
            baseCanvas = document.createElement('canvas');
            baseCtx = baseCanvas.getContext('2d');
            baseCanvas.style.zIndex = 0;
            canvasContainer.appendChild(baseCanvas);
            baseCtx.fillStyle = 'black';
            baseCtx.fillRect(0, 0, baseCanvas.width, baseCanvas.height);
        }

        function createNewLayer() {
            if (currentCanvas) {
                baseCtx.drawImage(currentCanvas, 0, 0);
                canvasContainer.removeChild(currentCanvas);
            }
            currentCanvas = document.createElement('canvas');
            currentCtx = currentCanvas.getContext('2d');
            currentCanvas.style.zIndex = 1;
            canvasContainer.appendChild(currentCanvas);
            resizeCanvas();
        }

        createBaseCanvas();
        createNewLayer();
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // 터치 이벤트 리스너
        currentCanvas.addEventListener('touchstart', startDrawing);
        currentCanvas.addEventListener('touchmove', draw);
        currentCanvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
            startRecording();
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = currentCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            currentCtx.lineWidth = 2;
            currentCtx.lineCap = 'round';
            currentCtx.strokeStyle = 'white';

            currentCtx.lineTo(x, y);
            currentCtx.stroke();
            currentCtx.beginPath();
            currentCtx.moveTo(x, y);
        }

        function stopDrawing() {
            isDrawing = false;
            currentCtx.beginPath();
            stopRecording();
            createNewLayer();
        }

        // 녹화 기능
        function startRecording() {
            chunks = [];
            const stream = currentCanvas.captureStream(30);
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
            mediaRecorder.onstop = createVideo;

            mediaRecorder.start();
        }

        function stopRecording() {
            mediaRecorder.stop();
        }

        function createVideo() {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString();
            recordedVideos.push({ url, timestamp });
            updateVideoList();
        }

        function updateVideoList() {
            videoList.innerHTML = '';
            recordedVideos.forEach((video, index) => {
                const item = document.createElement('div');
                item.className = 'videoItem';
                item.innerHTML = `
                    <span>영상 ${index + 1} (${video.timestamp})</span>
                    <a href="${video.url}" download="video_${index + 1}.webm">다운로드</a>
                `;
                videoList.appendChild(item);
            });
        }

        // 초기화 버튼
        resetBtn.addEventListener('click', () => {
            baseCtx.fillStyle = 'black';
            baseCtx.fillRect(0, 0, baseCanvas.width, baseCanvas.height);
            createNewLayer();
            recordedVideos = [];
            updateVideoList();
        });
    </script>
</body>
</html>
